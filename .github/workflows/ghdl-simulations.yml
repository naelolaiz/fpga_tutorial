name: CI
# Controls when the workflow will run
env:
  REGISTRY: ghcr.io
on:
  # Triggers the workflow on push or pull request events but only for the "main" branch
  push:
    branches: [ "poc-using-docker-image-to-generate-diagrams" ]
  pull_request:
    branches: [ "poc-using-docker-image-to-generate-diagrams" ]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:
jobs:
  ubuntu:
    strategy:
      fail-fast: false
      matrix:
        backend: [ '', mcode, llvm, gcc ]
        version: [ 20.04, latest ]
        #version: [ 18.04, 20.04, latest ] # TODO: put 18.04 back commenting screenshots generation on it
    runs-on: ubuntu-${{ matrix.version }}
    name: 'üêß Ubuntu ${{ matrix.version }} ¬∑ ${{ matrix.backend }}'
    container:
      image: ghcr.io/naelolaiz/hdltools:release
      credentials:
         username: ${{ github.actor }}
         password: ${{ secrets.github_token }}
      volumes:
        - ${{ github.workspace }}/src:/src
        - ${{ github.workspace }}/scripts:/scripts
        - ${{ github.workspace }}/created_images:/created_images
    steps:

    - name: create output dir for images
      run: mkdir /created_images
    
    - name: 'üß∞ Checkout'
      uses: actions/checkout@v2

    - name: testbench_sanity_check_expect_error
      run: |
        echo "GHDL_PREFIX: $GHDL_PREFIX"
        echo "GHDL: $GHDL"
        echo "GHDL_LIBS: $GHDL_LIBS"
        $GHDL --version
        cd /src/3-testbench/sanity_check_tb
        $GHDL -a sanity_check_tb.vhd
        $GHDL -e sanity_check_tb
        ./sanity_check_tb --assert-level=error && exit -1 || echo "Expected failure OK!"

    - name: testbench_styles_example
      run: |
        cd src/1-styles-vhdl
        $GHDL -a dataflow_example.vhd
        $GHDL -a structural_components.vhd
        $GHDL -a structural_example.vhd
        $GHDL -a behavioral_example.vhd
        $GHDL -a styles_example_tb.vhd
        $GHDL -e styles_example_tb
        $GHDL -r styles_example_tb --assert-level=error --vcd=styles_example_tb.vcd
        python3 /scripts/gtkwave_export.py styles_example_tb.vcd
        mv gtkwave_styles_example_tb.png /created_images/

    - name: testbench_testbench_example
      run: |
        cd src/3-testbench
        $GHDL -a toplevel_timer.vhd
        $GHDL -a toplevel_timer_tb.vhd
        $GHDL -e toplevel_timer_tb
        $GHDL -r toplevel_timer_tb --assert-level=error --vcd=toplevel_timer_tb.vcd
        python3 /scripts/gtkwave_export.py toplevel_timer_tb.vcd
        mv gtkwave_toplevel_timer_tb.png /created_images/

    - uses: actions/upload-artifact@v3
      with:
        name: screenshots-${{ matrix.version }}${{ matrix.backend }}
        path: ${{ github.workspace }}/created_images/
